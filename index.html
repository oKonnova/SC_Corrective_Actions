<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Tokenomics Live Demo</title>
    <!-- React and ReactDOM -->
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <!-- Ethers.js for blockchain interaction -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Babel to transpile JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        body {
            background-color: #f8fafc; 
            font-family: 'Inter', sans-serif;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .btn {
            transition: all 0.2s ease-in-out;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .status-log {
            height: 200px;
            background-color: #1a202c;
            color: #a0aec0;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.875rem;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-y: scroll;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const App = () => {
            // --- STATE MANAGEMENT ---
            const [isLoading, setIsLoading] = useState(false);
            const [logs, setLogs] = useState(["Initializing..."]);
            const [chartData, setChartData] = useState(null);
            const [chartInstance, setChartInstance] = useState(null);
            const chartRef = useRef(null);

            // --- CONFIGURATION ---
            const TOKEN_ADDRESS = '0x594AA2E8fAF9558345011af8c229497c712c39B2'; // SCPlusToken address
            const SUBSCRIPTION_ADDRESS = '0x5C3E7846B0fe0B5a79fA85DcD6d16Fe033426eBf'; // Address of the contract that WILL use AI actions.
            const SUBSCRIPTION_NO_ACTION_ADDRESS = '0x064c37f003b3EdDDDdd61De2f4c1B42D8F5FFF1E'; // Address of the second contract that WILL NOT use AI actions.

            // --- UTILITY FUNCTIONS ---
            const formatUSD = (bn) => Number(ethers.utils.formatUnits(bn, 8)).toFixed(2);
            const formatPLT = (bn) => Number(ethers.utils.formatUnits(bn, 18)).toFixed(2);

            // --- CONSTANTS ---
            const ACTION_MAP = {
                0: "No Action", 1: "Lower Subscription Price", 2: "Raise Subscription Price",
                3: "Sell 10% Reserve", 4: "Buy-Back Tokens", 5: "Sell 20% Reserve"
            };

            const scenarios = [
                { name: "Month 1", userChange: 0.05, priceChange: 0.03 }, { name: "Month 2", userChange: 0.10, priceChange: 0.08 },
                { name: "Month 3", userChange: -0.10, priceChange: -0.15 }, { name: "Month 4", userChange: 0.08, priceChange: 0.10 },
                { name: "Month 5", userChange: 0.12, priceChange: 0.07 }, { name: "Month 6", userChange: 0.18, priceChange: 0.15 },
                { name: "Month 7", userChange: -0.15, priceChange: -0.20 }, { name: "Month 8", userChange: 0.05, priceChange: 0.04 },
                { name: "Month 9", userChange: 0.15, priceChange: 0.12 }, { name: "Month 10", userChange: 0.20, priceChange: 0.18 },
                { name: "Month 11", userChange: -0.08, priceChange: -0.12 }, { name: "Month 12", userChange: 0.25, priceChange: 0.20 }
            ];

            const SUBSCRIPTION_ABI = [
                "function tokenPriceUSD() view returns (uint256)", "function activeUsers() view returns (uint256)",
                "function tokenAmount() view returns (uint256)", "function reserveBalance() view returns (uint256)",
                "function runScenario(uint256 _lastPrice, uint256 _fiatAmount, int256 _userChange, uint256 _action) external"
            ];
            
            const TOKEN_ABI = ["function approve(address spender, uint256 amount) external returns (bool)"];

            // --- LOGGING UTILITY ---
            const log = (message) => {
                console.log(message);
                setLogs(prev => [...prev.slice(-100), `[${new Date().toLocaleTimeString()}] ${message}`]);
            };

            // --- CHART RENDERING ---
            useEffect(() => {
                if (chartData && chartRef.current) {
                    if (chartInstance) chartInstance.destroy();
                    const ctx = chartRef.current.getContext('2d');
                    const newChartInstance = new Chart(ctx, {
                        type: 'line',
                        data: chartData,
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { position: 'top' },
                                title: { display: true, text: 'Token Price Simulation: AI vs. No AI', font: { size: 18 } }
                            },
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    title: { display: true, text: 'Token Price (USD)' },
                                    ticks: { callback: value => '$' + value.toFixed(2) }
                                }
                            }
                        }
                    });
                    setChartInstance(newChartInstance);
                }
            }, [chartData]);

            // --- ACTION EVALUATION LOGIC (HEURISTIC MODEL) ---
            const evaluateMarketActions = (fiatAmount, reserveBalance, tokenPriceUsd, tokenAmount) => {
                const actions = {};
                
                // Action 3: Sell 10% of reserve
                const sell10Amount = 0.1 * reserveBalance;
                const fiatGained10 = sell10Amount * tokenPriceUsd;
                const newFiat10 = fiatAmount + fiatGained10;
                const newTokenAmount10 = tokenAmount - sell10Amount;
                actions[3] = newTokenAmount10 > 0 ? newFiat10 / newTokenAmount10 : 0;
                
                // Action 4: Buy back tokens using 10% of the fiat reserve
                const fiatToSpend = 0.1 * fiatAmount;
                const tokensToBuy = tokenPriceUsd > 0 ? fiatToSpend / tokenPriceUsd : 0;
                const newFiatBuy = fiatAmount - fiatToSpend;
                const newTokenAmountBuy = tokenAmount - tokensToBuy; 
                actions[4] = (newTokenAmountBuy > 0 && newFiatBuy > 0) ? newFiatBuy / newTokenAmountBuy : 0;
                
                // Find the action that results in the best new token price
                let bestAction = 0;
                let maxImpact = -Infinity;
                for (const action in actions) {
                    if (actions[action] > maxImpact) {
                        maxImpact = actions[action];
                        bestAction = action;
                    }
                }
                return Number(bestAction);
            };
            
            const evaluateSubscriptionPrice = (userChangePercent, latestPriceChange, fiatAmount, reserveBalance, tokenPriceUSD, tokenAmount) => {
                const fiatAmountNum = Number(ethers.utils.formatUnits(fiatAmount, 8));
                const reserveBalanceNum = Number(ethers.utils.formatUnits(reserveBalance, 18));
                const tokenPriceUsdNum = Number(ethers.utils.formatUnits(tokenPriceUSD, 8));
                const tokenAmountNum = Number(ethers.utils.formatUnits(tokenAmount, 18));

                if (userChangePercent < 5 && latestPriceChange > 5) return 1;
                if (userChangePercent > 5 && latestPriceChange < -5) return 2;
                if (latestPriceChange < -20) return 5;
                if (latestPriceChange >= 15 || latestPriceChange <= -10) {
                    return evaluateMarketActions(fiatAmountNum, reserveBalanceNum, tokenPriceUsdNum, tokenAmountNum);
                }
                return 0;
            };

            // --- CORE SIMULATION LOGIC ---
            const runSingleScenario = async (provider, scenario, contractAddress, useAiAction) => {
                const logPrefix = useAiAction ? "[AI]" : "[Control]";
                const signer = provider.getSigner();
                const subscription = new ethers.Contract(contractAddress, SUBSCRIPTION_ABI, signer);

                log(`${logPrefix} Running: ${scenario.name}`);

                // Get state from the contract *before* the scenario runs
                const initialPrice = await subscription.tokenPriceUSD();
                const currentTokenAmount = await subscription.tokenAmount();
                const currentUsers = await subscription.activeUsers();
                const reserveBalance = await subscription.reserveBalance();

                // Calculate the new market parameters based on the scenario
                const targetPriceUSD = initialPrice.mul(Math.round((1 + scenario.priceChange) * 100)).div(100);
                const newFiatAmount = targetPriceUSD.mul(currentTokenAmount).div(ethers.utils.parseUnits("1", 18));
                const userChange = Math.round(currentUsers.toNumber() * scenario.userChange);

                let predictedAction = 0;
                if (useAiAction) {
                    const userChangePercent = (userChange / currentUsers.toNumber()) * 100;
                    predictedAction = evaluateSubscriptionPrice(userChangePercent, scenario.priceChange * 100, newFiatAmount, reserveBalance, targetPriceUSD, currentTokenAmount);
                    log(`${logPrefix} 🧠 Heuristic Predicted Action: ${ACTION_MAP[predictedAction]}`);
                    
                    // If the action is a buy-back, we must approve the contract to spend tokens first.
                    if (predictedAction === 4) {
                        log(`${logPrefix} Approval required for Buy-Back. Please confirm in MetaMask.`);
                        const tokenContract = new ethers.Contract(TOKEN_ADDRESS, TOKEN_ABI, signer);
                        // Approve a large amount to avoid repeated approvals during the demo.
                        const approveTx = await tokenContract.approve(contractAddress, ethers.constants.MaxUint256);
                        await approveTx.wait();
                        log(`${logPrefix} ✅ Approval successful.`);
                    }
                }

                // Execute the entire scenario in one transaction
                const tx = await subscription.runScenario(initialPrice, newFiatAmount, userChange, predictedAction);
                await tx.wait();
                log(`${logPrefix} Scenario executed on-chain.`);

                const finalPrice = await subscription.tokenPriceUSD();
                log(`${logPrefix} Final price for this step: $${formatUSD(finalPrice)}`);
                return parseFloat(formatUSD(finalPrice));
            };

            const handleRunAll = async () => {
                if (!window.ethereum) return log("❌ MetaMask is not installed.");
                setIsLoading(true);
                setChartData(null);
                log("--- STARTING PARALLEL SIMULATION ---");

                try {
                    const provider = new ethers.providers.Web3Provider(window.ethereum);
                    await provider.send("eth_requestAccounts", []);
                    log("Wallet connected.");
                    log("NOTE: This demo requires both contracts to be in identical initial states for a valid comparison.");

                    const pricesWithAi = [];
                    const pricesWithoutAi = [];

                    for (const scenario of scenarios) {
                        log(`\n--- SCENARIO: ${scenario.name} ---`);
                        const priceAi = await runSingleScenario(provider, scenario, SUBSCRIPTION_ADDRESS, true);
                        pricesWithAi.push(priceAi);
                        const priceNoAi = await runSingleScenario(provider, scenario, SUBSCRIPTION_NO_ACTION_ADDRESS, false);
                        pricesWithoutAi.push(priceNoAi);
                    }

                    setChartData({
                        labels: scenarios.map(s => s.name),
                        datasets: [
                            {
                                label: 'Price with AI Actions',
                                data: pricesWithAi,
                                borderColor: 'rgb(59, 130, 246)',
                                backgroundColor: 'rgba(59, 130, 246, 0.5)',
                                tension: 0.2, borderWidth: 2.5
                            },
                            {
                                label: 'Price without AI (Control)',
                                data: pricesWithoutAi,
                                borderColor: 'rgb(239, 68, 68)',
                                backgroundColor: 'rgba(239, 68, 68, 0.5)',
                                tension: 0.2, borderWidth: 2.5, borderDash: [5, 5]
                            }
                        ]
                    });
                    log("\n✅ Full simulation complete. Chart updated.");
                } catch (error) {
                    log(`❌ An error occurred: ${error.message}`);
                    console.error(error);
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="p-4 md:p-8 max-w-7xl mx-auto">
                    <header className="text-center mb-8">
                        <h1 className="text-4xl font-bold text-gray-800">Smart contracts with NN correction action simulation</h1>
                        <p className="text-lg text-gray-500 mt-2">Live Simulation on the Sepolia Testnet</p>
                    </header>
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div className="lg:col-span-1">
                            <div className="card">
                                <h2 className="text-2xl font-semibold text-gray-700 mb-4">Controls</h2>
                                <button
                                    className="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg btn"
                                    onClick={handleRunAll}
                                    disabled={isLoading}
                                >
                                    {isLoading ? 'Simulation in Progress...' : '▶️ Run Simulation'}
                                </button>
                                <div className="mt-4 space-y-2">
                                    <a href={`https://sepolia.etherscan.io/address/${SUBSCRIPTION_ADDRESS}`} target="_blank" rel="noopener noreferrer" className="block w-full text-center bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg btn">
                                        View AI Contract on Etherscan
                                    </a>
                                    <a href={`https://sepolia.etherscan.io/address/${SUBSCRIPTION_NO_ACTION_ADDRESS}`} target="_blank" rel="noopener noreferrer" className="block w-full text-center bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg btn">
                                        View Control Contract on Etherscan
                                    </a>
                                </div>
                            </div>
                            <div className="card">
                                <h2 className="text-2xl font-semibold text-gray-700 mb-4">Live Status Log</h2>
                                <div className="status-log" ref={el => el && (el.scrollTop = el.scrollHeight)}>
                                    {logs.map((logMsg, i) => <div key={i}>{logMsg}</div>)}
                                </div>
                            </div>
                        </div>
                        <div className="lg:col-span-2">
                            <div className="card">
                                <h2 className="text-2xl font-semibold text-gray-700 mb-4">Simulation Results</h2>
                                {chartData ? (
                                    <canvas ref={chartRef}></canvas>
                                ) : (
                                    <div className="text-center py-16 text-gray-500">
                                        <p>Chart will be displayed here after running the simulation.</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
